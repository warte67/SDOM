#!/usr/bin/env bash
set -euo pipefail

USAGE() {
  cat <<'EOF'
Usage: ./compile [clean] [release] [asan]

  clean   Remove existing build folders before configuring
  release Configure both SDOM and the test harness for Release (can be combined with other flags)
  asan    Enable AddressSanitizer for both SDOM and the test harness

Additional options can be added later; unknown flags are rejected to catch typos.
EOF
}

# Resolve the repo root (two levels up from this script)
WORKSPACE="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
INSTALL_PREFIX="${INSTALL_PREFIX:-$HOME/.local}"

CLEAN=false
BUILD_TYPE=${BUILD_TYPE:-Debug}
ASAN=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    clean)
      CLEAN=true
      ;;
    release)
      BUILD_TYPE="Release"
      ;;
    asan)
      ASAN=true
      ;;
    -h|--help)
      USAGE
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      USAGE >&2
      exit 1
      ;;
  esac
  shift
done

# Default sanitizer environment when ASAN is enabled.
# Keep leak detection on, but suppress known external (HarfBuzz/SDL) leaks.
if [[ "$ASAN" == true ]]; then
  export ASAN_OPTIONS="detect_leaks=1:${ASAN_OPTIONS:-}"
  export LSAN_OPTIONS="suppressions=${WORKSPACE}/examples/test/asan_lsan.supp:${LSAN_OPTIONS:-}"
fi

# Determine available CPU count
if command -v nproc >/dev/null 2>&1; then
  CORES="$(nproc)"
elif command -v getconf >/dev/null 2>&1; then
  CORES="$(getconf _NPROCESSORS_ONLN)"
else
  CORES=4
fi

# --- Handle clean flag ---
if [[ "$CLEAN" == true ]]; then
  echo "Cleaning $WORKSPACE/build and $WORKSPACE/examples/test/build ..."
  rm -rf "$WORKSPACE/build" "$WORKSPACE/examples/test/build"
fi

echo "Workspace: $WORKSPACE"
echo "Install prefix: $INSTALL_PREFIX"
echo "Build type: $BUILD_TYPE"
echo "ASAN: $ASAN"
if [[ "$ASAN" == true ]]; then
  echo "ASAN_OPTIONS=${ASAN_OPTIONS}"
  echo "LSAN_OPTIONS=${LSAN_OPTIONS}"
  echo "Tip: run the ASan binary via ./run_asan.sh to apply leak suppressions."
fi

# --- Configure and build the core library ---
cmake -S "$WORKSPACE" -B "$WORKSPACE/build" \
      -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX" \
      -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
      -DCMAKE_PREFIX_PATH="$HOME/.local;/usr/local;${CMAKE_PREFIX_PATH:-}" \
      $($ASAN && echo -DENABLE_ASAN=ON) >/dev/null

# Track timestamps to detect rebuild
LIB_TARGET=$(find "$WORKSPACE/build" -maxdepth 1 -type f -name "libSDOM.*" | head -n1)
[[ -f "$LIB_TARGET" ]] && BEFORE_TIME=$(stat -c %Y "$LIB_TARGET") || BEFORE_TIME=0

# Build
cmake --build "$WORKSPACE/build" -j"$CORES" --config "$BUILD_TYPE"

# Detect whether target changed
LIB_TARGET=$(find "$WORKSPACE/build" -maxdepth 1 -type f -name "libSDOM.*" | head -n1)
AFTER_TIME=$( [[ -f "$LIB_TARGET" ]] && stat -c %Y "$LIB_TARGET" || echo 0 )

if [[ "$AFTER_TIME" -gt "$BEFORE_TIME" ]]; then
  echo "Changes detected — installing library..."
  cmake --install "$WORKSPACE/build" --config "$BUILD_TYPE"
else
  echo "No changes detected — skipping install."
fi

# --- Build the test application ---
cmake -S "$WORKSPACE/examples/test" -B "$WORKSPACE/examples/test/build" \
      -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
      -DCMAKE_PREFIX_PATH="$HOME/.local;/usr/local;${CMAKE_PREFIX_PATH:-}" \
      $($ASAN && echo -DENABLE_ASAN=ON) >/dev/null
cmake --build "$WORKSPACE/examples/test/build" -j"$CORES" --config "$BUILD_TYPE"
