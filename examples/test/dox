#!/usr/bin/env bash
set -euo pipefail

# Resolve repo root relative to this script
SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd -- "$SCRIPT_DIR/../.." && pwd)"

# 1) Regenerate Mermaid diagrams (PNG/SVG)
if [[ -x "$REPO_ROOT/scripts/export_mermaid.sh" ]]; then
	echo "[dox] Exporting Mermaid diagrams..."
	bash "$REPO_ROOT/scripts/export_mermaid.sh"
else
	echo "[dox] Warning: scripts/export_mermaid.sh not found or not executable; skipping diagram export" >&2
fi

# 2) Run Doxygen from the docs directory
echo "[dox] Running Doxygen..."
cd "$REPO_ROOT/docs"
doxygen
echo "[dox] Done."

# 3) Ensure SVG/PNG diagrams are available alongside generated HTML
if [[ -d "$REPO_ROOT/docs/diagrams" ]]; then
	echo "[dox] Copying diagrams to docs/html/diagrams for site compatibility..."
	mkdir -p "$REPO_ROOT/docs/html/diagrams"
	cp -rT "$REPO_ROOT/docs/diagrams" "$REPO_ROOT/docs/html/diagrams"
fi
