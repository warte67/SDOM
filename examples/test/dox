#!/usr/bin/env bash
# =============================================================================
# SDOM Documentation and Conditional Version Regeneration Script
# -----------------------------------------------------------------------------
# Description:
#   - Rebuilds documentation via Doxygen
#   - Regenerates version header only if source files have changed
#   - Keeps version numbers stable across doc-only edits
#
# Usage:
#   ./scripts/dox
#
# Author: Jay Faries (warte67)
# =============================================================================

set -euo pipefail

# Resolve repo root
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$ROOT_DIR"

GEN_SCRIPT="scripts/gen_version.sh"
DOXYFILE="docs/Doxyfile"
VERSION_TRACK_FILE=".version_last_hash"

# -----------------------------------------------------------------------------
# Detect source changes
# -----------------------------------------------------------------------------
echo "üîç Checking for source changes..."

# Hash all relevant source directories (headers, src, Lua scripts)
CURRENT_HASH=$(find src include examples/test/lua -type f \( -name '*.cpp' -o -name '*.hpp' -o -name '*.h' -o -name '*.lua' \) \
  -exec sha1sum {} + | sha1sum | awk '{print $1}')

PREV_HASH=""
[[ -f "$VERSION_TRACK_FILE" ]] && PREV_HASH=$(<"$VERSION_TRACK_FILE")

# -----------------------------------------------------------------------------
# Always rebuild documentation
# -----------------------------------------------------------------------------
if [[ -f "$DOXYFILE" ]]; then
  echo "üìò Running Doxygen..."
  doxygen "$DOXYFILE" >/dev/null 2>&1 || { echo "‚ùå Doxygen failed"; exit 1; }
  echo "‚úÖ Documentation updated."
else
  echo "‚ö†Ô∏è Doxygen config not found: $DOXYFILE"
fi

# -----------------------------------------------------------------------------
# Conditionally regenerate version header
# -----------------------------------------------------------------------------
if [[ "$CURRENT_HASH" != "$PREV_HASH" ]]; then
  echo "üÜï Source changes detected ‚Äî regenerating version header..."
  if [[ -x "$GEN_SCRIPT" ]]; then
    "$GEN_SCRIPT"
    echo "$CURRENT_HASH" > "$VERSION_TRACK_FILE"
  else
    echo "‚ö†Ô∏è Version generator not executable or missing: $GEN_SCRIPT"
  fi
else
  echo "‚è© No source changes ‚Äî skipping version bump."
fi

# -----------------------------------------------------------------------------
# Optionally open docs
# -----------------------------------------------------------------------------
if [[ -d docs/html ]]; then
  echo "üåê Opening generated documentation..."
  xdg-open docs/html/index.html >/dev/null 2>&1 &
fi
