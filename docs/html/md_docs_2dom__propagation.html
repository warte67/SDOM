<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SDOM - Simple SDL Document Object Model: DOM Propagation Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SDOM - Simple SDL Document Object Model
   </div>
   <div id="projectbrief">A lightweight, extensible Document Object Model for SDL-based applications.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_docs_2dom__propagation.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">DOM Propagation Design</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md69"></a> </p>
<h1><a class="anchor" id="autotoc_md70"></a>
Overview</h1>
<p>In <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a>, the Document Object Model (DOM) is a hierarchical tree structure representing all displayable and interactive elements in the system. Each element in the tree is called a node or object, and may have parent/child relationships with other nodes. Nodes can represent UI components, containers, or other resources.</p>
<p>DOM trees are inherently recursive: each node may contain children, and traversal algorithms typically use recursion to visit every node in the hierarchy. Because of this recursive nature, modifying the tree (such as adding or removing nodes) while it is being traversed can disrupt the traversal process. Changes made mid-recursion can invalidate pointers, break parent/child relationships, or cause traversal algorithms to miss nodes or revisit them incorrectly. In the worst case, this can lead to segmentation faults or other critical errors if the recursion encounters a node that has been deleted or moved unexpectedly.</p>
<p>Propagation refers to the process by which changes, events, or updates move through the DOM tree. This includes traversing the tree for rendering, layout, and event delivery (such as mouse clicks or keyboard input). Propagation ensures that updates and events reach the appropriate nodes in the correct order.</p>
<p>To prevent these issues, <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a> defers add/remove actions during traversal, applying them only after traversal completes. Outside of traversal (such as during initialization or setup), nodes can be added or removed immediately, allowing real-time construction and adjustment of the DOM tree.</p>
<p>This document outlines the four main types of DOM traversal and propagation strategies used in <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a>, their responsibilities, and where they are implemented in the architecture.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md72"></a>
Event Propagation Diagram</h1>
<p>SVG (static image): <img src="diagrams/dom_propagation/diagram-01.svg" alt="Event Propagation" style="pointer-events: none;" class="inline"/></p>
<details >
<summary >
View Mermaid source</summary>
<p></p>
<div class="fragment"><div class="line"> -norender</div>
<div class="line">flowchart TB</div>
<div class="line">  classDef phase fill:#f5f5f5,stroke:#999,color:#333</div>
<div class="line">  classDef node fill:#eef7ff,stroke:#4a90e2,color:#1a3b5d</div>
<div class="line"> </div>
<div class="line">  Root((Root)):::node</div>
<div class="line">  P1((Parent)):::node</div>
<div class="line">  T((Target)):::node</div>
<div class="line"> </div>
<div class="line">  subgraph Capture[Capture Phase]</div>
<div class="line">    Root --&gt; P1 --&gt; T</div>
<div class="line">  end</div>
<div class="line"> </div>
<div class="line">  subgraph Target[Target Phase]</div>
<div class="line">    T</div>
<div class="line">  end</div>
<div class="line"> </div>
<div class="line">  subgraph Bubble[Bubbling Phase]</div>
<div class="line">    T --&gt; P1 --&gt; Root</div>
<div class="line">  end</div>
<div class="line"> </div>
<div class="line">  %% Notes: some mmdc versions may not render notes reliably</div>
</div><!-- fragment --><p></p>
</details>
<h1><a class="anchor" id="autotoc_md73"></a>
Traversal Types</h1>
<h2><a class="anchor" id="autotoc_md74"></a>
1. Core-based DOM Traversal (Type 1)</h2>
<ul>
<li><b>Purpose:</b> Rendering, updating, and layout of the active DOM tree.</li>
<li><b>Implementation:</b> <br  />
<ul>
<li>Managed by the <code>Core</code> object.</li>
<li>Uses recursive lambdas for traversal, rather than having each node call its own children.</li>
<li>Only traverses nodes that are active, visible, and enabled.</li>
<li>Nodes in different trees or disabled branches are skipped.</li>
<li>Does <b>not</b> guarantee that all DOM objects will be traversed.</li>
</ul>
</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md76"></a>
2. EventManager-based Event Traversal (Type 2)</h2>
<ul>
<li><b>Purpose:</b> Event propagation (bubbling/capturing) through the DOM tree.</li>
<li><b>Implementation:</b> <br  />
<ul>
<li>Managed by the <code>EventManager</code> (planned, reference code exists).</li>
<li>Traverses the DOM tree similarly to display traversal, but for event delivery.</li>
<li>Propagation stops at disabled nodes or when an event is consumed.</li>
<li>Only traverses the active DOM tree.</li>
</ul>
</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md78"></a>
3. Factory-based Global Traversal (Type 3)</h2>
<ul>
<li><b>Purpose:</b> Operations on all resources, regardless of DOM structure (e.g., shutdown, global events).</li>
<li><b>Implementation:</b> <br  />
<ul>
<li>Managed by the <code>Factory</code>.</li>
<li>Iterates through all <code>IResourceObject</code> instances in the Factory’s internal container.</li>
<li>Used for global operations such as calling <code>onQuit()</code> on every resource or handling global events.</li>
<li>Ignores parent/child relationships and node state.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md79"></a>
4. World Coordinate Backpropagation Traversal (Type 4)</h2>
<ul>
<li><b>Purpose:</b> Calculating each node's world coordinates based on its hierarchical position and anchor relationships within the DOM tree.</li>
<li><b>Implementation:</b> <br  />
<ul>
<li>Each node has four edges (left, top, right, bottom), and each edge can be anchored to one of nine reference points on its parent (see AnchorPoint enum).</li>
<li>Type 4 traversal recursively walks up the DOM tree from a node to its ancestors, backpropagating anchor relationships to compute the node's absolute world coordinates.</li>
<li>This process ensures that every node's position and size are accurately determined in relation to its parent and the overall DOM hierarchy.</li>
<li>Modifying the tree during this traversal can disrupt coordinate calculations, so changes should be deferred until traversal completes.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md80"></a>
Traversal Safety and Modification</h1>
<p>To ensure safe modification of the DOM tree during traversal, all three traversal types (Core, EventManager, Factory) should set an <code>isTraversing</code> flag to <code>true</code> at the start of traversal and clear it when traversal ends.</p>
<ul>
<li><b>Modification Blocking:</b><ul>
<li>While <code>isTraversing</code> is <code>true</code>, add/remove child operations must be blocked or deferred.</li>
<li>Deferred operations can be stored in a queue/list and processed after traversal completes.</li>
</ul>
</li>
<li><b>Thread Safety:</b><ul>
<li>If multithreading is supported, use a mutex or lock to prevent other threads from modifying the DOM tree while traversal is active.</li>
<li>This ensures that no thread can add or remove children if the primary thread is traversing.</li>
</ul>
</li>
<li><b>Type-specific Safety:</b><ul>
<li>Type 1 (Core) and Type 2 (EventManager) traversals require strict safety, as they affect display and event propagation.</li>
<li>Type 3 (Factory/global) traversals are less critical but should still respect the <code>isTraversing</code> flag for consistency.</li>
</ul>
</li>
</ul>
<p>This approach maintains the integrity of the DOM tree and event system, preventing undefined behavior and race conditions during traversal.</p>
<p><b>Note on Initialization and Active Nodes:</b> During initialization (such as building the DOM tree from Lua modules or manual setup), the <code>isTraversing</code> flag should be false, allowing immediate parent/child modifications. This enables real-time adjustment of relationships as nodes are created and attached, without waiting for a deferred update cycle.</p>
<p>However, when a node is active (i.e., it is the current target during DOM traversal or event handling), any add/remove child actions will be deferred until traversal completes. For example, if a <code>Button</code> object responds to a <code>MouseClick</code> event in its <code>Button::onEvent()</code> method, it can request add/remove actions on other nodes, but these changes will not take effect until the next update cycle after traversal ends.</p>
<p>The <code>onEvent()</code> method can poll the traversal state (e.g., via <code>Core::getIsTraversing()</code>) to determine whether changes will be immediate or deferred. This allows event handlers to request structural changes, knowing they will be safely applied after traversal, and that any new links or removals will only be reflected in the DOM tree on the next cycle.</p>
<h2><a class="anchor" id="autotoc_md81"></a>
Deferred actions processing (pseudo)</h2>
<p>When traversal completes, process the deferred queue with validation. Example pseudocode:</p>
<div class="fragment"><div class="line"><span class="comment">// thread-safe deferred queue processing (single-consumer expected)</span></div>
<div class="line"><span class="keywordtype">void</span> processDeferred() {</div>
<div class="line">  std::lock_guard&lt;std::mutex&gt; lk(deferredMutex);</div>
<div class="line">  <span class="keywordflow">while</span> (!deferredQueue.empty()) {</div>
<div class="line">    <span class="keyword">auto</span> req = std::move(deferredQueue.front());</div>
<div class="line">    deferredQueue.pop();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Validate target and operation</span></div>
<div class="line">    <span class="keywordflow">if</span> (!isValid(req.target)) {</div>
<div class="line">      <a class="code hl_define" href="SDOM_8hpp.html#a21a2c7330a04ac78200a986f66609369">DEBUG_LOG</a>(<span class="stringliteral">&quot;Deferred request target invalid: &quot;</span> &lt;&lt; req.describe());</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Apply the change (add/remove/replace)</span></div>
<div class="line">    applyRequest(req);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="ttc" id="aSDOM_8hpp_html_a21a2c7330a04ac78200a986f66609369"><div class="ttname"><a href="SDOM_8hpp.html#a21a2c7330a04ac78200a986f66609369">DEBUG_LOG</a></div><div class="ttdeci">#define DEBUG_LOG(...)</div><div class="ttdoc">Logs a debug message in green text.</div><div class="ttdef"><b>Definition</b> SDOM.hpp:355</div></div>
</div><!-- fragment --><p>Processing should run on the main thread immediately after traversal finishes (or at a deterministic point in the update loop). If an operation cannot be applied (target destroyed, invalid parent, etc.), log and skip the request rather than crashing.</p>
<h2><a class="anchor" id="autotoc_md82"></a>
Thread-safety notes</h2>
<ul>
<li>Use an atomic <code>isTraversing</code> or protect traversal state with a mutex when multiple threads may read/write this flag.</li>
<li>Protect the deferred request queue with a mutex; prefer a single consumer (the main thread) to avoid complex synchronization.</li>
</ul>
<p>Traversal safety checks only apply during active traversal phases (rendering, event propagation, etc.).</p>
<h1><a class="anchor" id="autotoc_md83"></a>
Architectural Separation</h1>
<ul>
<li><b>Core</b>: Handles display/layout traversal (Type 1).</li>
<li><b>EventManager</b>: Handles event propagation traversal (Type 2).</li>
<li><b>Factory</b>: Handles global resource traversal (Type 3).</li>
</ul>
<p>This separation ensures modularity, maintainability, and clarity in the codebase. Each traversal type can be extended or optimized independently.</p>
<h1><a class="anchor" id="autotoc_md84"></a>
Migration note</h1>
<p>If you previously used JSON to programmatically build a DOM (for example, exported from design tools), convert those configuration files into Lua modules that return tables. Lua modules are easier to compose, can contain helper logic, and integrate directly with the runtime Lua state.</p>
<p>Example JSON → Lua mapping:</p>
<p>JSON: </p><div class="fragment"><div class="line">{ &quot;type&quot;: &quot;Button&quot;, &quot;x&quot;: 10, &quot;y&quot;: 10 }</div>
</div><!-- fragment --><p>Lua module: </p><div class="fragment"><div class="line">return { type = &quot;Button&quot;, x = 10, y = 10 }</div>
</div><!-- fragment --><p>For bulk conversions, a small script to read JSON and write <code>.lua</code> files is recommended; alternatively, add a Lua JSON library to your runtime if you must parse JSON at runtime.</p>
<p><b>Note on Deferred Request Validation (Future Consideration):</b> When processing deferred add/remove actions after traversal, each request should be validated to ensure the target node is still valid and available. If a requested action cannot be performed (e.g., the target node is destroyed or missing), log an error or warning for debugging, and consider notifying the requesting node so it can handle the failure gracefully. This helps prevent inconsistent DOM states and improves robustness. Further strategies for error handling and notification may be considered in future revisions.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md86"></a>
Next Steps</h1>
<ul>
<li>Continue developing the EventManager for robust event propagation.</li>
<li>Refactor and document traversal logic in Core and Factory as needed.</li>
<li>Ensure all traversal types are well-tested and documented. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<footer>
  <a href="#top">Back to top</a> &nbsp;|&nbsp; <a href="https://github.com/warte67/SDOM">Back to SDOM on GitHub</a>
</footer>