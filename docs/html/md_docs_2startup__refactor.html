<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.15.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SDOM - Simple SDL Document Object Model: Startup Refactor Proposal</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">SDOM - Simple SDL Document Object Model
   </div>
   <div id="projectbrief">A lightweight, extensible Document Object Model for SDL-based applications.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.15.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_docs_2startup__refactor.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Startup Refactor Proposal </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md406"></a></p>
<p>The current startup logic in <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a> relies on legacy patterns from its early JSON-based design, where the engine automatically parses a global table named <span class="tt">Core</span> or <span class="tt">config</span> to initialize itself. While this approach was convenient for simple bootstrapping, it has become a limitation as the engine and its scripting capabilities have grown. Implicit startup makes the initialization sequence harder to control, debug, and extend, especially for advanced use cases or custom workflows. Mixing configuration parsing with resource creation and engine startup also leads to fragile code and restricts flexibility for users who want more explicit control. By refactoring to an explicit initialization pattern—where users directly call <span class="tt">Core:create()</span> and <span class="tt">Core:run()</span>—the engine will support clearer, more maintainable, and modern integration with both Lua and C++. This change will make <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a> easier to document, extend, and use in a wide range of application designs.</p>
<p>Reserving the name <span class="tt">Core</span> as the central global Lua table remains a sensible design choice, even with the move to explicit initialization. Having a well-known, consistent entry point for engine configuration and control helps users quickly understand how to interact with <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a> from Lua, and it provides a natural place to attach engine-wide methods, properties, and callbacks. By keeping <span class="tt">Core</span> as the global table, you maintain backward compatibility with existing scripts and examples, while also making it easier to document and standardize the API. The key improvement is to require explicit calls to <span class="tt">Core:create(config)</span> and <span class="tt">Core:run()</span>, rather than relying on automatic parsing of the table's contents. This approach combines the clarity and flexibility of explicit startup with the convenience and discoverability of a single, reserved global entry point.</p>
<p>In the current <a class="el" href="namespaceSDOM.html" title="Contains all core classes and utilities for the SDOM library.">SDOM</a> design, both <span class="tt">Core</span> and <span class="tt">CoreForward</span> are used in the Lua state. <span class="tt">Core</span> serves as the main global entry point for engine configuration and control, while <span class="tt">CoreForward</span> acts as a forwarding table to preserve engine API bindings if the global <span class="tt">Core</span> table is overwritten or replaced by user scripts. This pattern ensures that engine methods and properties remain accessible even if scripts redefine or shadow the <span class="tt">Core</span> table. As we refactor startup logic, we can keep <span class="tt">CoreForward</span> as an internal mechanism to maintain API stability, but encourage users to interact with the reserved global <span class="tt">Core</span> table for all engine operations. Documenting this distinction will help users understand the purpose of each and avoid confusion when customizing or extending the engine from Lua.</p>
<p>As part of the next phase of the startup refactor, we plan to transition from exposing the Core and CoreForward tables directly in Lua to using an internal-only identifier such as <b>sdom_core_object</b>. This hidden engine handle will manage all internal state and lifecycle, reducing the risk of naming collisions and accidental modification by user scripts. Instead of requiring users to interact with the <span class="tt">Core</span> table, we will bind all essential engine properties, functions, and methods as global Lua functions, making the API more concise and script-friendly. This approach streamlines the user experience, allowing scripts to call engine features directly without referencing a specific object. Legacy support for Core and CoreForward will remain during the transition, but new documentation and examples will focus on the global function pattern for clarity and maintainability.</p>
<p><b>Current limitations:</b></p><ul>
<li>The engine expects a global table named <span class="tt">Core</span> (or <span class="tt">config</span>) and auto-parses it, which is a legacy pattern from JSON-centric bootstrapping.</li>
<li>This makes startup implicit, less flexible, and harder to extend or debug.</li>
<li>It also mixes config parsing with resource creation and engine startup, which can be fragile.</li>
</ul>
<p><b>Recommended redesign:</b></p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md407"></a>
1. Explicit Initialization Pattern</h2>
<p><b>Lua-side:</b> </p><div class="fragment"><div class="line">local my_config = {</div>
<div class="line">    window_width = 1200,</div>
<div class="line">    window_height = 800,</div>
<div class="line">    -- ... other settings ...</div>
<div class="line">    children = { ... }</div>
<div class="line">}</div>
<div class="line">Core:create(my_config)</div>
<div class="line">Core:run()</div>
</div><!-- fragment --><p><b>C++-side:</b> </p><div class="fragment"><div class="line">CoreConfig config = { <span class="comment">/* ... */</span> };</div>
<div class="line">core.create(config);</div>
<div class="line">core.run();</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md408"></a>
2. Remove Automatic Table Parsing</h2>
<ul>
<li>Deprecate auto-parsing of global <span class="tt">Core</span> or <span class="tt">config</span> tables.</li>
<li>Require explicit calls to <span class="tt">Core:create(table)</span> or <span class="tt">Core:create(config_struct)</span>.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md409"></a>
3. Separate Config Parsing from Resource Creation</h2>
<ul>
<li>Make <span class="tt">Core:create()</span> responsible for parsing the config and creating resources.</li>
<li>Allow users to call <span class="tt">Core:run()</span> only after setup is complete.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md410"></a>
4. Update Documentation and Examples</h2>
<ul>
<li>Show explicit initialization in both Lua and C++.</li>
<li>Document the expected config structure and startup sequence.</li>
</ul>
<hr  />
<p><b>Migration Checklist:</b></p><ol type="1">
<li>Refactor <span class="tt">configureFromLua</span> and <span class="tt">configureFromLuaFile</span> to only parse and validate config, not auto-create resources.</li>
<li>Move resource creation logic into <span class="tt">Core:create(table)</span> and <span class="tt">Core:create(config_struct)</span>.</li>
<li>Update Lua bindings to expose <span class="tt">create</span> and <span class="tt">run</span> methods.</li>
<li>Remove legacy auto-table parsing from startup.</li>
<li>Update all examples and docs to use explicit initialization.</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md413"></a>
Step-by-Step Refactoring Strategy</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md414"></a>
1. Deprecate Automatic Table Parsing</h2>
<ul>
<li>Remove or mark as deprecated the code that automatically parses global tables named <span class="tt">Core</span> or <span class="tt">config</span> for engine startup.</li>
<li>Update warnings and documentation to inform users of the new explicit initialization pattern.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md415"></a>
2. Introduce Explicit Initialization Methods</h2>
<ul>
<li>Implement and expose <span class="tt">Core:create()</span> and <span class="tt">Core:run()</span> methods in both Lua and C++.</li>
<li>Ensure these methods handle configuration parsing, resource creation, and engine startup in a clear, user-driven sequence.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md416"></a>
3. Bind Engine Functions as Lua Globals</h2>
<ul>
<li>Bind essential engine functions (e.g., <span class="tt">create</span>, <span class="tt">run</span>, <span class="tt">shutdown</span>) as global Lua functions for direct access.</li>
<li>Internally, reference the engine instance using an obscure identifier (e.g., <span class="tt">__sdom_core_object__</span>) to avoid naming collisions.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md417"></a>
4. Maintain Legacy Support During Transition</h2>
<ul>
<li>Keep <span class="tt">Core</span> and <span class="tt">CoreForward</span> available for backward compatibility, but mark them as deprecated.</li>
<li>Document the transition and encourage users to migrate to the new global function pattern.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md418"></a>
5. Refactor Resource Creation Logic</h2>
<ul>
<li>Move resource creation out of config parsing functions and into the explicit <span class="tt">create</span> method.</li>
<li>Ensure that configuration parsing and resource instantiation are clearly separated.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md419"></a>
6. Update Documentation and Examples</h2>
<ul>
<li>Revise all documentation, tutorials, and example scripts to use the new explicit initialization and global function pattern.</li>
<li>Clearly explain the new startup sequence and configuration structure.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md420"></a>
7. Test and Validate</h2>
<ul>
<li>Thoroughly test the new startup flow in both Lua and C++ environments.</li>
<li>Validate that legacy scripts still work and that new scripts benefit from improved clarity and flexibility.</li>
</ul>
<hr  />
<p><b>Benefits:</b></p><ul>
<li><b>Clarity:</b> Users control when and how the engine starts.</li>
<li><b>Flexibility:</b> Supports advanced scripting, multi-stage setups, and custom bootstrapping.</li>
<li><b>Maintainability:</b> Easier to debug, extend, and document.</li>
<li><b>Modern API:</b> Matches best practices for Lua/C++ engine integration.</li>
</ul>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<footer>
  <a href="#top">Back to top</a> &nbsp;|&nbsp; <a href="https://github.com/warte67/SDOM">Back to SDOM on GitHub</a>
</footer>
