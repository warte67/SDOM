#!/bin/bash

# Usage: ./rebuild [local] [asan]
#  - local  : Debug build, install to $HOME/.local
#  - (none) : Release build, install to /usr/local
#  - asan   : Enable AddressSanitizer on core library build (works with either mode)
#
# Examples:
#   ./rebuild local            # Debug + local install
#   ./rebuild                  # Release + system install
#   ./rebuild local asan       # Debug + ASAN + local install
#   ./rebuild asan             # Release + ASAN + system install
#
# Make sure your headers are in include/SDOM/ and your CMakeLists.txt uses:
#   install(DIRECTORY ${PROJECT_SOURCE_DIR}/include/SDOM DESTINATION include)

BUILD_DIR="build"

# Parse args
LOCAL=false
ENABLE_ASAN=false
for arg in "$@"; do
  case "$arg" in
    local) LOCAL=true ;;
    asan)  ENABLE_ASAN=true ;;
    *) ;;
  esac
done

echo "Cleaning build artifacts..."
rm -rf "$BUILD_DIR"
mkdir -p "$BUILD_DIR"
cd "$BUILD_DIR"

if $LOCAL; then
  echo "Running cmake for local install (Debug)..."
  if $ENABLE_ASAN; then
    echo "ASAN: enabled for core library"
    cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX="$HOME/.local" -DENABLE_ASAN=ON ..
  else
    cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX="$HOME/.local" ..
  fi
  make -j$(nproc)
  make install
else
  echo "Running cmake for system install (Release)..."
  if $ENABLE_ASAN; then
    echo "ASAN: enabled for core library"
    cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local -DENABLE_ASAN=ON ..
  else
    cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local ..
  fi
  make -j$(nproc)
  sudo make install
fi
