#!/usr/bin/env bash
# update_latest_anchor.sh
# -------------------------------------------------------------
# Automatically moves or creates the <a id="latest-update"></a>
# anchor in docs/progress.md so it appears immediately above the
# most recent daily heading (e.g., "## ðŸ—“ï¸ November 4, 2025").
#
# If no entry exists for today, this script will automatically
# insert a new daily heading along with a starter progress
# template below it, ready for editing.
#
# Run this at the start of each new day before logging progress.
# -------------------------------------------------------------

set -euo pipefail

PROG_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
REPO_ROOT=$(cd -- "${PROG_DIR}/.." && pwd)
FILE="${REPO_ROOT}/docs/progress.md"

if [[ ! -f "${FILE}" ]]; then
  echo "[update_latest_anchor] File not found: ${FILE}" >&2
  exit 0
fi

tmp_out=$(mktemp)

# Allow override for testing (e.g., SDOM_TODAY="November 1, 2025")
if [[ -n "${SDOM_TODAY:-}" ]]; then
  TODAY="$SDOM_TODAY"
else
  TODAY=$(date '+%B %-d, %Y' 2>/dev/null || date '+%B %e, %Y')
fi

# Normalize spacing (handles double-space in some locales)
TODAY=$(echo "$TODAY" | sed 's/  / /g')

awk -v TODAY="$TODAY" '
  BEGIN {
    months = "January|February|March|April|May|June|July|August|September|October|November|December"
    heading_re = "^##[[:space:]]+.*(" months ") [0-9]{1,2}, [0-9]{4}"
    last_idx = 0
    out_n = 0
    today_idx = 0
    eod_idx = 0
  }

  {
    # Remove any existing <a id="latest-update"></a> anchors
    if ($0 ~ /^<a id="latest-update"><\/a>$/) next

    out_n++
    lines[out_n] = $0

    if ($0 ~ heading_re) last_idx = out_n
    if ($0 ~ /^####[[:space:]]+end-of-day(.*)$/) eod_idx = out_n
    if ($0 ~ /^##[[:space:]]+/ && index($0, TODAY) > 0) today_idx = out_n
  }

  END {
    # Fallback: catch older date heading formats
    if (last_idx == 0) {
      for (i = 1; i <= out_n; i++) {
        if (lines[i] ~ /^###[[:space:]]*\[[A-Za-z]+ [0-9]{1,2}, [0-9]{4}\]/)
          last_idx = i
      }
    }

    insert_anchor_at = 0
    insert_new_heading = 0
    new_heading_line = ""

    if (today_idx > 0) {
      insert_anchor_at = today_idx
    } else if (eod_idx > 0) {
      insert_anchor_at = eod_idx + 1  # ensure new block appears AFTER last dayâ€™s terminator
      insert_new_heading = 1
      new_heading_line = "## ðŸ—“ï¸ " TODAY " â€” [Title Placeholder]"
    } else if (last_idx > 0) {
      insert_anchor_at = last_idx
    } else {
      for (i = 1; i <= out_n; i++) print lines[i]
      exit 0
    }

    # Markdown template for new daily section
    template_block = "_[Brief summary of todayâ€™s focus or achievements.]_\n\n" \
    "### ðŸ§© [Subsystem or Feature Group]\n" \
    "- [Key change or feature accomplished.]\n" \
    "- [Supporting details, design notes, or rationale.]\n\n" \
    "### ðŸŒŸ **Summary:**\n" \
    "_[Short summary of results and next direction.]_\n\n" \
    "**ðŸš§ ToDo Today**\n" \
    "- â˜ [Task 1]\n" \
    "- â˜ [Task 2]\n\n"

    for (i = 1; i <= out_n; i++) {
      if (i == insert_anchor_at) {
        print "<a id=\"latest-update\"></a>"

        if (insert_new_heading) {
          # Add blank line separation if not already present
          if (out_n > 0 && lines[out_n] !~ /^$/) print ""
          
          print new_heading_line
          print ""

          # Only insert the full template if file does NOT already end with "end-of-day"
          if (lines[out_n] !~ /^####[[:space:]]+end-of-day(.*)$/) {
            print template_block
          } else {
            # Avoid duplicate terminators
            print "_[Brief summary of todayâ€™s focus or achievements.]_"
            print ""
          }
        }
      }

      print lines[i]
    }
  }
' "${FILE}" >"${tmp_out}"

# Only update file if there are changes
if ! cmp -s "${FILE}" "${tmp_out}"; then
  mv "${tmp_out}" "${FILE}"
  echo "[update_latest_anchor] Updated: ${FILE}"
else
  rm -f "${tmp_out}"
  echo "[âœ“] Progress log up-to-date (no changes)"
fi
